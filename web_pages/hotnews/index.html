<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HotNewsï½œé‡ç‚¹æ–°é—» + ä¸‰æ–¹è§†è§’</title>
  <style>
    body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",sans-serif; margin:0; padding:22px; background:#0b1220; color:#e5e7eb; }
    h1 { margin:0 0 8px; font-size:28px; }
    h2 { margin:18px 0 10px; font-size:20px; }
    .meta { color:#9ca3af; margin-bottom:12px; }
    .toolbar { display:flex; gap:8px; margin:8px 0 14px; }
    .btn { background:#1d4ed8; color:#fff; border:none; border-radius:8px; padding:6px 10px; font-size:13px; cursor:pointer; }
    .btn:hover { background:#1e40af; }
    .card { background:#111827; border:1px solid #1f2937; border-radius:14px; padding:14px; margin-bottom:14px; }
    .event { font-weight:700; margin-bottom:10px; color:#f9fafb; }
    .event .en { display:block; margin-top:4px; color:#93c5fd; font-size:13px; font-weight:500; }
    .grid { display:grid; grid-template-columns: repeat(3,minmax(220px,1fr)); gap:10px; }
    .col { background:#0f172a; border:1px solid #1e293b; border-radius:10px; padding:10px; }
    .col h3 { margin:0 0 6px; font-size:15px; color:#c7d2fe; }
    .empty { color:#64748b; font-size:13px; }
    .sourceTag { display:inline-block; background:#1e293b; color:#cbd5e1; border-radius:999px; padding:2px 8px; font-size:12px; margin-right:8px; }
    .insight { margin-top:10px; background:#0b1a33; border:1px solid #1d3b70; border-radius:8px; padding:10px; font-size:14px; line-height:1.5; }
    a { color:#93c5fd; text-decoration:none; }
    a:hover { text-decoration:underline; }
    @media (max-width:900px){ .grid{grid-template-columns:1fr;} }
  </style>
</head>
<body>
  <h1>HotNewsï¼šé‡ç‚¹æ–°é—» + ä¸‰æ–¹è§†è§’å¯¹æ¯”</h1>
  <div class="meta" id="meta">åŠ è½½ä¸­... / Loading...</div>
  <div class="toolbar" style="margin-bottom:14px;">
    <button id="readAllBtn" class="btn">ğŸ”Š æœ—è¯»é‡ç‚¹è§£è¯» / Read Insights</button>
  </div>

  <h2>1ï¼‰é‡ç‚¹æ–°é—»ï¼ˆç›´æ¥åˆ—å‡ºï¼‰</h2>
  <div id="headlines"></div>

  <h2>2ï¼‰è¢«ä¸¤ä¸ªä»¥ä¸Šåª’ä½“æåˆ°çš„äº‹ä»¶ï¼ˆä¸‰æ–¹è§†è§’ + æˆ‘çš„çœ‹æ³•ï¼‰</h2>
  <div id="events"></div>

  <script>
    const AZURE_TTS_BASE = 'https://web-x0ya.onrender.com';
    let __hotnewsData = null;

    async function speakWithAzure(text){
      const q = encodeURIComponent(text);
      const voice = encodeURIComponent('en-US-JennyNeural');
      const url = `${AZURE_TTS_BASE}/tts?text=${q}&voice=${voice}`;
      const resp = await fetch(url, { method: 'GET' });
      if(!resp.ok) throw new Error('TTS request failed: ' + resp.status);
      const blob = await resp.blob();
      if (!blob || blob.size < 1024) throw new Error('Azure returned empty audio');
      const audioUrl = URL.createObjectURL(blob);
      const audio = new Audio(audioUrl);
      await audio.play();
    }

    function speakFallback(text){
      if (!('speechSynthesis' in window)) return;
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'zh-CN';
      window.speechSynthesis.speak(u);
    }

    function renderPerspective(container, title, item){
      const col = document.createElement('div');
      col.className = 'col';
      col.innerHTML = `<h3>${title}</h3>`;
      if(item && item.link){
        const zh = item.title_zh || item.title || '';
        const en = item.title_en || item.title || '';
        col.innerHTML += `<div><a href="${item.link}" target="_blank" rel="noreferrer">${zh}</a></div>
                          <div style="margin-top:6px;color:#93c5fd;font-size:13px;line-height:1.35;">${en}</div>`;
      } else {
        col.innerHTML += `<div class="empty">æš‚æ— åŒ¹é…è§‚ç‚¹ / No matched perspective</div>`;
      }
      container.appendChild(col);
    }

    async function load(){
      const res = await fetch('./data/news.json?_=' + Date.now());
      const data = await res.json();
      __hotnewsData = data;

      document.getElementById('meta').textContent = `æœ€åæ›´æ–° / Last update: ${data.generated_at}ï¼ˆæ¯æ—¥ 08:00 è‡ªåŠ¨æ›´æ–°ï¼‰`;

      // Section 1 headlines
      const h = document.getElementById('headlines');
      h.innerHTML = '';
      (data.headlines || []).forEach(it => {
        const card = document.createElement('div');
        card.className = 'card';
        const zh = it.title_zh || it.title;
        const en = it.title_en || it.title;
        card.innerHTML = `<div><span class="sourceTag">${it.source}</span><a href="${it.link}" target="_blank" rel="noreferrer">${zh}</a></div>
                          <div style="margin-top:6px;color:#93c5fd;font-size:13px;line-height:1.35;">${en}</div>`;
        h.appendChild(card);
      });

      // Section 2 cross events
      const ev = document.getElementById('events');
      ev.innerHTML = '';
      const events = data.cross_events || [];
      if(!events.length){
        ev.innerHTML = '<div class="card">æš‚æ— å¯å¯¹æ¯”äº‹ä»¶ã€‚</div>';
        return;
      }

      events.forEach((c, idx) => {
        const card = document.createElement('div');
        card.className = 'card';
        const zh = c.event_hint_zh || c.event_hint || '';
        const en = c.event_hint_en || c.event_hint || '';
        card.innerHTML = `<div class="event">äº‹ä»¶ / Event ${idx+1}ï¼š${zh}<span class="en">${en}</span></div>`;

        const grid = document.createElement('div');
        grid.className = 'grid';
        renderPerspective(grid, 'ä¸­å›½è§†è§’ / China', c['ä¸­å›½è§†è§’']);
        renderPerspective(grid, 'ç¾å›½è§†è§’ / US', c['ç¾å›½è§†è§’']);
        renderPerspective(grid, 'ä¼Šæ–¯å…°è§†è§’ / Islamic (Al Jazeera)', c['åŠå²›è§†è§’']);
        card.appendChild(grid);

        const insight = document.createElement('div');
        insight.className = 'insight';
        insight.innerHTML = `<div><b>æˆ‘çš„çœ‹æ³•ï¼š</b>${c.my_view || ''}</div><div style="margin-top:6px;"><b>æ€»ç»“ï¼š</b>${c.summary || ''}</div>`;
        card.appendChild(insight);
        ev.appendChild(card);
      });
    }

    document.getElementById('readAllBtn').onclick = async () => {
      const events = (__hotnewsData && __hotnewsData.cross_events) ? __hotnewsData.cross_events : [];
      if (!events.length) return;
      const text = events.map((e, i) => `ç¬¬${i+1}æ¡ã€‚${e.event_hint_zh || ''}ã€‚æˆ‘çš„çœ‹æ³•ï¼š${e.my_view || ''}ã€‚æ€»ç»“ï¼š${e.summary || ''}`).join(' ');
      try { await speakWithAzure(text); }
      catch(e){ speakFallback(text); }
    };

    load().catch(e => {
      document.getElementById('meta').textContent = 'åŠ è½½å¤±è´¥ / Load failed: ' + e.message;
    });
  </script>
</body>
</html>
