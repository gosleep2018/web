<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CNN/BBC æ¯æ—¥10è¯ - Azure TTS + è¯æ ¹è¯ç¼€</title>
  <style>
    *{box-sizing:border-box}body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background:#0f172a;color:#e2e8f0}
    .wrap{max-width:960px;margin:0 auto;padding:20px}
    h1{font-size:28px;margin:0 0 10px;color:#60a5fa}
    .sub{color:#94a3b8;margin-bottom:16px}
    .bar{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0 20px}
    button{border:0;border-radius:10px;padding:10px 14px;cursor:pointer;color:#fff;background:#2563eb;transition:all .2s}
    button:hover{background:#1d4ed8;transform:translateY(-1px)}
    button.warn{background:#ef4444}button.alt{background:#475569}
    button:disabled{opacity:.5;cursor:not-allowed}
    .card{background:#1e293b;border:1px solid #334155;border-radius:12px;padding:20px;margin:16px 0}
    .word{font-size:24px;font-weight:700}.ph{color:#94a3b8;font-style:italic}
    .row{margin-top:8px;line-height:1.6}.zh{color:#fbbf24}
    .etymology{background:rgba(37,99,235,0.1);border-left:3px solid #2563eb;padding:12px;margin:10px 0;border-radius:0 8px 8px 0}
    .etymology-title{color:#60a5fa;font-weight:600;margin-bottom:6px}
    .example{padding:12px;border-left:3px solid #10b981;background:rgba(16,185,129,0.1);border-radius:0 8px 8px 0;margin-top:10px}
    .history{margin-top:28px}.history h2{font-size:20px;color:#93c5fd}
    details{background:#111827;border:1px solid #334155;border-radius:10px;padding:8px 12px;margin:8px 0}
    summary{cursor:pointer;color:#cbd5e1}
    .tag{display:inline-block;background:#334155;color:#e2e8f0;border-radius:999px;padding:4px 10px;margin:4px 6px 4px 0;font-size:12px}
    .tag.prefix{background:#3b82f6}.tag.root{background:#10b981}.tag.suffix{background:#8b5cf6}.tag.related{background:#f59e0b}
    .muted{color:#94a3b8;font-size:13px}
    .audio-status{display:inline-block;margin-left:8px;font-size:12px}
    .tips{background:rgba(245,158,11,0.1);border-left:3px solid #f59e0b;padding:12px;margin:15px 0;border-radius:0 8px 8px 0}
    .loading{display:none;color:#60a5fa;margin-left:8px}
    .tts-badge{background:#3b82f6;color:white;padding:2px 8px;border-radius:4px;font-size:12px;margin-left:8px}
  </style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ¯ CNN/BBC æ¯æ—¥10è¯ <span class="tts-badge">Azure TTS</span></h1>
  <div class="sub">ğŸ¤– å¾®è½¯Azureç¥ç»ç½‘ç»œTTS â€¢ ğŸ§ è¯æ ¹è¯ç¼€è®°å¿†æ³• â€¢ ğŸ“– æ·±åº¦å­¦ä¹ </div>
  
  <div class="tips">
    <div class="etymology-title">ğŸ§ Azure TTS å‘éŸ³ç³»ç»Ÿ</div>
    <div>â€¢ <strong>ä¸“ä¸šç¥ç»ç½‘ç»œè¯­éŸ³</strong>ï¼šå¾®è½¯Azureæœ€é«˜è´¨é‡è¯­éŸ³åˆæˆ</div>
    <div>â€¢ <strong>ä¸‰ç§å‘éŸ³æ¨¡å¼</strong>ï¼šå•è¯å‘éŸ³ + ä¾‹å¥å‘éŸ³ + é‡Šä¹‰å‘éŸ³</div>
    <div>â€¢ <strong>æ™ºèƒ½æ§åˆ¶</strong>ï¼šæ’­æ”¾/åœæ­¢ + æ‰¹é‡æ’­æ”¾ + é”®ç›˜å¿«æ·é”®</div>
    <div>â€¢ <strong>ç¦»çº¿ç¼“å­˜</strong>ï¼šå·²æ’­æ”¾çš„éŸ³é¢‘è‡ªåŠ¨ç¼“å­˜ï¼Œæ— éœ€é‡å¤è¯·æ±‚</div>
  </div>
  
  <div class="bar">
    <button onclick="playAllWords()">ğŸ”Š æ’­æ”¾ä»Šæ—¥10è¯ (Azure TTS)</button>
    <button onclick="playAllExamples()">ğŸ§ æ’­æ”¾ä»Šæ—¥ä¾‹å¥ (Azure TTS)</button>
    <button onclick="playAllDefinitions()">ğŸ“– æ’­æ”¾ä»Šæ—¥é‡Šä¹‰ (Azure TTS)</button>
    <button class="warn" onclick="stopAllAudio()">â¹ åœæ­¢æ‰€æœ‰å‘éŸ³</button>
    <button class="alt" onclick="refreshToday(true)">ğŸ”„ é‡æ–°æŠ½å–ä»Šæ—¥10è¯</button>
    <span class="loading" id="loading">åŠ è½½ä¸­...</span>
  </div>
  
  <div id="today"></div>

  <div class="history">
    <h2>ğŸ“š å†å²è®°å½•ï¼ˆå¤ä¹ ï¼‰</h2>
    <div class="muted">è‡ªåŠ¨è®°å½•æ¯å¤©çš„10ä¸ªå•è¯ã€‚å¯ç‚¹å¼€æŒ‰æ—¥æœŸå¤ä¹ ã€‚</div>
    <div id="history"></div>
  </div>
</div>

<script>
// ==================== é…ç½® ====================
const TTS_PROXY_URL = 'http://localhost:3000/tts';
const TODAY_VOICE = 'en-US-JennyNeural';
const EXAMPLE_VOICE = 'en-US-JennyNeural';
const DEF_VOICE = 'en-US-GuyNeural';

// ==================== è¯æ±‡åº“ ====================
const VOCAB_WITH_ETYMOLOGY = [
  {
    word: "sanction",
    phonetic: "/ËˆsÃ¦Å‹kÊƒn/",
    chinese: "åˆ¶è£",
    englishDef: "A penalty imposed by one country on another.",
    example: "New sanctions were announced on Friday.",
    exampleTrans: "å‘¨äº”å®£å¸ƒäº†æ–°åˆ¶è£ã€‚",
    source: "BBC",
    etymology: {
      prefix: "",
      root: "-sanct- (ç¥åœ£çš„ï¼Œæ¥è‡ªæ‹‰ä¸è¯­ sanctus)",
      suffix: "-tion (åè¯åç¼€ï¼Œè¡¨ç¤ºè¡Œä¸ºæˆ–çŠ¶æ€)",
      memoryTip: "sanction åŸæŒ‡'ç¥åœ£åŒ–' â†’ å¼•ç”³ä¸º'å®˜æ–¹æ‰¹å‡†' â†’ ç°ä»£ä¹‰'åˆ¶è£'ï¼ˆå®˜æ–¹æ–½åŠ çš„æƒ©ç½šï¼‰",
      relatedWords: ["sanctuary (é¿éš¾æ‰€)", "sanctify (ä½¿ç¥åœ£åŒ–)", "sanctimonious (å‡è£…ç¥åœ£çš„)"]
    }
  },
  {
    word: "benchmark",
    phonetic: "/ËˆbentÊƒmÉ‘Ëk/",
    chinese: "åŸºå‡†",
    englishDef: "A standard for comparison.",
    example: "Oil prices hit a new benchmark.",
    exampleTrans: "æ²¹ä»·è§¦åŠæ–°åŸºå‡†ã€‚",
    source: "BBC",
    etymology: {
      prefix: "",
      root: "å¤åˆè¯ï¼šbench (é•¿å‡³) + mark (æ ‡è®°)",
      suffix: "",
      memoryTip: "å†å²ï¼šæµ‹é‡å‘˜åœ¨é•¿å‡³ä¸Šåšæ ‡è®°ä½œä¸ºå‚è€ƒç‚¹ â†’ å¼•ç”³ä¸º'åŸºå‡†'",
      relatedWords: ["landmark (åœ°æ ‡)", "hallmark (æ ‡å¿—)", "watermark (æ°´å°)"]
    }
  },
  {
    word: "innovation",
    phonetic: "/ËŒÉªnÉ™ËˆveÉªÊƒn/",
    chinese: "åˆ›æ–°",
    englishDef: "A new method, idea, or product.",
    example: "Technological innovation is driving growth.",
    exampleTrans: "æŠ€æœ¯åˆ›æ–°æ­£åœ¨æ¨åŠ¨å¢é•¿ã€‚",
    source: "BBC",
    etymology: {
      prefix: "in- (è¿›å…¥ï¼Œä½¿...)",
      root: "-nov- (æ–°çš„ï¼Œæ‹‰ä¸è¯­ novus)",
      suffix: "-ation (åè¯åç¼€ï¼Œè¡¨ç¤ºè¡Œä¸ºæˆ–ç»“æœ)",
      memoryTip: "å­—é¢ï¼šä½¿è¿›å…¥æ–°çŠ¶æ€ â†’ åˆ›æ–°",
      relatedWords: ["novel (æ–°é¢–çš„)", "renovate (ç¿»æ–°)", "nova (æ–°æ˜Ÿ)", "novice (æ–°æ‰‹)"]
    }
  },
  {
    word: "sovereignty",
    phonetic: "/ËˆsÉ’vrÉ™nti/",
    chinese: "ä¸»æƒ",
    englishDef: "A state's authority to govern itself.",
    example: "The debate focused on national sovereignty.",
    exampleTrans: "è®¨è®ºèšç„¦å›½å®¶ä¸»æƒã€‚",
    source: "CNN",
    etymology: {
      prefix: "",
      root: "-sovereign- (æœ€é«˜çš„ï¼Œç»Ÿæ²»çš„ï¼Œæ¥è‡ªå¤æ³•è¯­ soverain)",
      suffix: "-ty (åè¯åç¼€ï¼Œè¡¨ç¤ºçŠ¶æ€æˆ–æ€§è´¨)",
      memoryTip: "sovereign (å›ä¸») + -ty â†’ å›ä¸»çš„çŠ¶æ€ â†’ ä¸»æƒ",
      relatedWords: ["sovereign (å›ä¸»)", "reign (ç»Ÿæ²»)", "sovereignty dispute (ä¸»æƒäº‰ç«¯)"]
    }
  },
  {
    word: "compliance",
    phonetic: "/kÉ™mËˆplaÉªÉ™ns/",
    chinese: "åˆè§„",
    englishDef: "Conforming to rules or standards.",
    example: "The company improved its compliance procedures.",
    exampleTrans: "å…¬å¸æ”¹è¿›äº†åˆè§„ç¨‹åºã€‚",
    source: "CNN",
    etymology: {
      prefix: "com- (å…±åŒï¼Œå®Œå…¨)",
      root: "-pli- (æŠ˜å ï¼Œå¼¯æ›²ï¼Œæ‹‰ä¸è¯­ plicare)",
      suffix: "-ance (åè¯åç¼€ï¼Œè¡¨ç¤ºçŠ¶æ€)",
      memoryTip: "å­—é¢ï¼šå®Œå…¨æŠ˜å ï¼ˆå±ˆæœï¼‰â†’ éµå®ˆï¼Œé¡ºä»",
      relatedWords: ["comply (éµå®ˆ)", "compliant (é¡ºä»çš„)", "complex (å¤æ‚çš„)", "duplicate (å¤åˆ¶)"]
    }
  },
  {
    word: "inequality",
    phonetic: "/ËŒÉªnÉªËˆkwÉ’lÉ™ti/",
    chinese: "ä¸å¹³ç­‰",
    englishDef: "Lack of equality in society.",
    example: "The report highlights income inequality.",
    exampleTrans: "æŠ¥å‘Šå¼ºè°ƒäº†æ”¶å…¥ä¸å¹³ç­‰ã€‚",
    source: "BBC",
    etymology: {
      prefix: "in- (ä¸ï¼Œå¦å®š)",
      root: "-equ- (ç›¸ç­‰ï¼Œæ‹‰ä¸è¯­ aequus)",
      suffix: "-ity (åè¯åç¼€ï¼Œè¡¨ç¤ºçŠ¶æ€)",
      memoryTip: "ç»“æ„ï¼šin- (ä¸) + equal (å¹³ç­‰) + -ity (çŠ¶æ€) â†’ ä¸å¹³ç­‰çŠ¶æ€",
      relatedWords: ["equality (å¹³ç­‰)", "equitable (å…¬å¹³çš„)", "equator (èµ¤é“)", "equation (æ–¹ç¨‹å¼)"]
    }
  },
  {
    word: "enforcement",
    phonetic: "/ÉªnËˆfÉ”ËsmÉ™nt/",
    chinese: "æ‰§è¡Œ",
    englishDef: "Ensuring compliance with laws.",
    example: "Law enforcement agencies are investigating.",
    exampleTrans: "æ‰§æ³•æœºæ„æ­£åœ¨è°ƒæŸ¥ã€‚",
    source: "BBC",
    etymology: {
      prefix: "en- (ä½¿æˆä¸ºï¼Œæ”¾å…¥)",
      root: "-force- (åŠ›é‡ï¼Œæ‹‰ä¸è¯­ fortis)",
      suffix: "-ment (åè¯åç¼€ï¼Œè¡¨ç¤ºè¡Œä¸ºæˆ–ç»“æœ)",
      memoryTip: "å­—é¢ï¼šä½¿å…·æœ‰åŠ›é‡ â†’ å¼ºåˆ¶æ‰§è¡Œ",
      relatedWords: ["enforce (æ‰§è¡Œ)", "force (åŠ›é‡)", "reinforce (åŠ å¼º)", "fortify (åŠ å¼º)"]
    }
  },
  {
    word: "sustainability",
    phonetic: "/sÉ™ËŒsteÉªnÉ™ËˆbÉªlÉ™ti/",
    chinese: "å¯æŒç»­æ€§",
    englishDef: "Ability to maintain at a certain level.",
    example: "Sustainability is key for future growth.",
    exampleTrans: "å¯æŒç»­æ€§æ˜¯æœªæ¥å¢é•¿çš„å…³é”®ã€‚",
    source: "CNN",
    etymology: {
      prefix: "sus- (åœ¨ä¸‹é¢ï¼Œsub- å˜ä½“)",
      root: "-tain- (æŒæœ‰ï¼Œä¿æŒï¼Œæ‹‰ä¸è¯­ tenere)",
      suffix: "-able (èƒ½å¤Ÿ...çš„) + -ity (åè¯åç¼€ï¼Œè¡¨ç¤ºæ€§è´¨)",
      memoryTip: "ç»“æ„ï¼šsus- (åœ¨ä¸‹é¢) + tain (æŒæœ‰) + -able (èƒ½å¤Ÿ) + -ity (æ€§è´¨) â†’ èƒ½å¤ŸæŒç»­æ”¯æ’‘çš„æ€§è´¨",
      relatedWords: ["sustain (ç»´æŒ)", "maintain (ç»´æŒ)", "retain (ä¿ç•™)", "contain (åŒ…å«)"]
    }
  },
  {
    word: "diplomacy",
    phonetic: "/dÉªËˆplÉ™ÊŠmÉ™si/",
    chinese: "å¤–äº¤",
    englishDef: "Managing international relations.",
    example: "Diplomacy reduced tensions in the region.",
    exampleTrans: "å¤–äº¤ç¼“å’Œäº†åœ°åŒºç´§å¼ å±€åŠ¿ã€‚",
    source: "BBC",
    etymology: {
      prefix: "",
      root: "-diplo- (åŒé‡çš„ï¼ŒæŠ˜å çš„ï¼Œå¸Œè…Šè¯­ diploos)",
      suffix: "-macy (åè¯åç¼€ï¼Œæ¥è‡ªå¸Œè…Šè¯­ -mateia)",
      memoryTip: "å†å²ï¼šdiploma (æ–‡å‡­) åŸæŒ‡æŠ˜å çš„å®˜æ–¹æ–‡ä»¶ â†’ å¤–äº¤å®˜æºå¸¦çš„å‡­è¯ â†’ å¤–äº¤è‰ºæœ¯",
      relatedWords: ["diplomat (å¤–äº¤å®˜)", "diplomatic (å¤–äº¤çš„)", "diploma (æ–‡å‡­)", "duplicate (å¤åˆ¶)"]
    }
  },
  {
    word: "tariff",
    phonetic: "/ËˆtÃ¦rÉªf/",
    chinese: "å…³ç¨",
    englishDef: "A tax on imported goods.",
    example: "The new tariff affects steel imports.",
    exampleTrans: "æ–°å…³ç¨å½±å“é’¢é“è¿›å£ã€‚",
    source: "CNN",
    etymology: {
      prefix: "",
      root: "æ¥è‡ªé˜¿æ‹‰ä¼¯è¯­ ta'rif (é€šçŸ¥ï¼Œå…¬å‘Š)",
      suffix: "",
      memoryTip: "å†å²ï¼šåŸæŒ‡æ¸¯å£å…¬å¸ƒçš„å…³ç¨è¡¨ â†’ æ³›æŒ‡å…³ç¨",
      relatedWords: ["customs duty (å…³ç¨)", "import tax (è¿›å£ç¨)", "trade barrier (è´¸æ˜“å£å’)"]
    }
  },
  {
    word: "election",
    phonetic: "/ÉªËˆlekÊƒn/",
    chinese: "é€‰ä¸¾",
    englishDef: "A formal voting process to choose leaders.",
    example: "The presidential election will be held next month.",
    exampleTrans: "æ€»ç»Ÿé€‰ä¸¾å°†äºä¸‹ä¸ªæœˆä¸¾è¡Œã€‚",
    source: "CNN",
    etymology: {
      prefix: "e- (å‡ºï¼Œå‘å¤–)",
      root: "-lect- (é€‰æ‹©ï¼Œæ‹‰ä¸è¯­ legere)",
      suffix: "-ion (åè¯åç¼€ï¼Œè¡¨ç¤ºè¡Œä¸ºæˆ–ç»“æœ)",
      memoryTip: "å­—é¢ï¼šé€‰æ‹©å‡ºæ¥ â†’ é€‰ä¸¾",
      relatedWords: ["select (é€‰æ‹©)", "collect (æ”¶é›†)", "elect (é€‰ä¸¾)", "intellect (æ™ºåŠ›)"]
    }
  },
  {
    word: "summit",
    phonetic: "/ËˆsÊŒmÉªt/",
    chinese: "å³°ä¼š",
    englishDef: "A high-level meeting between leaders.",
    example: "World leaders will attend the climate summit.",
    exampleTrans: "ä¸–ç•Œé¢†å¯¼äººå°†å‡ºå¸­æ°”å€™å³°ä¼šã€‚",
    source: "CNN",
    etymology: {
      prefix: "",
      root: "æ¥è‡ªæ‹‰ä¸è¯­ summus (æœ€é«˜çš„)",
      suffix: "",
      memoryTip: "åŸä¹‰ï¼šå±±é¡¶ â†’ æœ€é«˜ç‚¹ â†’ æœ€é«˜çº§åˆ«ä¼šè®®",
      relatedWords: ["sum (æ€»å’Œ)", "summary (æ‘˜è¦)", "consummate (å®Œç¾çš„)"]
    }
  }
];

// ==================== çŠ¶æ€ç®¡ç† ====================
let currentAudio = null;
let isPlaying = false;
const audioCache = new Map();

// ==================== æ—¥æœŸå‡½æ•° ====================
function dateKey(){
  const d = new Date();
  const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),day=String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}

function seededShuffle(arr, seedStr){
  let seed = [...seedStr].reduce((a,c)=>a+c.charCodeAt(0),0) || 1;
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    seed = (seed * 9301 + 49297) % 233280;
    const j = Math.floor((seed/233280)*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

function getTodayWords(forceNew=false){
  const k = dateKey();
  const store = JSON.parse(localStorage.getItem('vocabHistory')||'{}');
  if(!forceNew && store[k] && store[k].length===10) return store[k];
  const picked = seededShuffle(VOCAB_WITH_ETYMOLOGY, k + (forceNew?'-force':'' )).slice(0,10);
  store[k]=picked;
  localStorage.setItem('vocabHistory', JSON.stringify(store));
  return picked;
}

// ==================== Azure TTS æ ¸å¿ƒå‡½æ•° ====================
async function speakWithAzureTTS(text, voice = TODAY_VOICE) {
  stopAllAudio();
  
  // æ£€æŸ¥ç¼“å­˜
  const cacheKey = `${voice}:${text}`;
  if (audioCache.has(cacheKey)) {
    console.log('ä½¿ç”¨ç¼“å­˜éŸ³é¢‘:', cacheKey);
    const audioUrl = audioCache.get(cacheKey);
    return playAudioFromUrl(audioUrl);
  }
  
  showLoading(true);
  
  try {
    const url = `${TTS_PROXY_URL}?text=${encodeURIComponent(text)}&voice=${voice}`;
    const response = await fetch(url);
    
    if (!response.ok) {
      throw new Error(`TTSè¯·æ±‚å¤±è´¥: ${response.status}`);
    }
    
    const audioBlob = await response.blob();
    const audioUrl = URL.createObjectURL(audioBlob);
    
    // ç¼“å­˜éŸ³é¢‘
    audioCache.set(cacheKey, audioUrl);
    
    showLoading(false);
    return playAudioFromUrl(audioUrl);
    
  } catch (error) {
    console.error('Azure TTSå¤±è´¥:', error);
    showLoading(false);
    // é™çº§åˆ°Web Speech API
    speakWithFallback(text);
  }
}

function playAudioFromUrl(audioUrl) {
  currentAudio = new Audio(audioUrl);
  currentAudio.onended = () => {
    isPlaying = false;
    updateAudioStatus();
  };
  currentAudio.onerror = (err) => {
    console.error('éŸ³é¢‘æ’­æ”¾é”™è¯¯:', err);
    isPlaying = false;
    updateAudioStatus();
  };
  
  isPlaying = true;
  updateAudioStatus();
  return currentAudio.play();
}

function speakWithFallback(text) {
  if ('speechSynthesis' in window) {
    stopAllAudio();
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'en-US';
    utterance.rate = 0.8;
    
    utterance.onend = () => {
      isPlaying = false;
      updateAudioStatus();
    };
    
    currentAudio = utterance;
    isPlaying = true;
    updateAudioStatus();
    speechSynthesis.speak(utterance);
  } else {
    alert('æŠ±æ­‰ï¼Œæ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆåŠŸèƒ½ã€‚è¯·ç¡®ä¿Azure TTSä»£ç†æœåŠ¡æ­£åœ¨è¿è¡Œã€‚');
  }
}

function stopAllAudio() {
  if (currentAudio instanceof Audio) {
    currentAudio.pause();
    currentAudio.currentTime = 0;
  } else if (currentAudio instanceof SpeechSynthesisUtterance) {
    speechSynthesis.cancel();
  }
  isPlaying = false;
  updateAudioStatus();
}

function updateAudioStatus() {
  const buttons = document.querySelectorAll('button');
  buttons.forEach(btn => {
    if (btn.textContent.includes('åœæ­¢')) {
      btn.style.display = isPlaying ? 'inline-block' : 'none';
    }
  });
}

function showLoading(show) {
  document.getElementById('loading').style.display = show ? 'inline-block' : 'none';
}

// ==================== æ’­æ”¾å‡½æ•° ====================
function playWord(word) { 
  speakWithAzureTTS(word, TODAY_VOICE); 
}

function playExample(sentence) { 
  speakWithAzureTTS(sentence, EXAMPLE_VOICE); 
}

function playDef(definition) { 
  speakWithAzureTTS(definition, DEF_VOICE); 
}

async function playAllWords() {
  const words = getTodayWords();
  stopAllAudio();
  
  for (const w of words) {
    if (!isPlaying) break;
    await speakWithAzureTTS(w.word, TODAY_VOICE);
    await waitForAudioEnd();
    await new Promise(r => setTimeout(r, 500));
  }
}

async function playAllExamples() {
  const words = getTodayWords();
  stopAllAudio();
  
  for (const w of words) {
    if (!isPlaying) break;
    await speakWithAzureTTS(w.example, EXAMPLE_VOICE);
    await waitForAudioEnd();
    await new Promise(r => setTimeout(r, 500));
  }
}

async function playAllDefinitions() {
  const words = getTodayWords();
  stopAllAudio();
  
  for (const w of words) {
    if (!isPlaying) break;
    await speakWithAzureTTS(w.englishDef, DEF_VOICE);
    await waitForAudioEnd();
    await new Promise(r => setTimeout(r, 500));
  }
}

function waitForAudioEnd() {
  return new Promise(resolve => {
    if (!currentAudio) {
      resolve();
      return;
    }
    
    const check = setInterval(() => {
      if (!isPlaying) {
        clearInterval(check);
        resolve();
      }
    }, 100);
    
    if (currentAudio instanceof Audio) {
      currentAudio.onended = () => {
        clearInterval(check);
        resolve();
      };
    }
  });
}

// ==================== æ¸²æŸ“å‡½æ•° ====================
function renderToday(forceNew=false){
  const box = document.getElementById('today');
  const words = getTodayWords(forceNew);
  const today = dateKey();
  const now = new Date();
  const timeStr = now.toLocaleTimeString('zh-CN', { hour12: false });
  
  let html = `<div class="muted">ä»Šæ—¥æ—¥æœŸï¼š${today}ï¼ˆ10ä¸ªï¼‰â€¢ ğŸ§ Azure TTS â€¢ æ›´æ–°æ—¶é—´: ${timeStr}</div>`;
  
  words.forEach((w, i) => {
    const etymology = w.etymology;
    html += `
    <div class="card">
      <div class="word">${i+1}. ${w.word}</div>
      <div class="ph">${w.phonetic}</div>
      <div class="row zh">ä¸­æ–‡è§£é‡Šï¼š${w.chinese}</div>
      <div class="row">è‹±æ–‡é‡Šä¹‰ï¼š${w.englishDef}</div>
      
      <div class="etymology">
        <div class="etymology-title">ğŸ” è¯æ ¹è¯ç¼€åˆ†æ</div>`;
    
    if (etymology.prefix) {
      html += `<div><span class="tag prefix">å‰ç¼€</span> <strong>${etymology.prefix}</strong></div>`;
    }
    if (etymology.root) {
      html += `<div><span class="tag root">è¯æ ¹</span> <strong>${etymology.root}</strong></div>`;
    }
    if (etymology.suffix) {
      html += `<div><span class="tag suffix">åç¼€</span> <strong>${etymology.suffix}</strong></div>`;
    }
    
    html += `
        <div class="muted" style="margin-top:8px">${etymology.memoryTip}</div>
        
        <div class="etymology-title" style="margin-top:12px">ğŸ§  åŒæºè¯æ‰©å±•</div>
        <div>`;
    
    etymology.relatedWords.forEach(related => {
      html += `<span class="tag related">${related}</span> `;
    });
    
    html += `</div>
      </div>
      
      <div class="example">
        <div><strong>${w.source}ä¾‹å¥ï¼š</strong>${w.example}</div>
        <div class="muted">${w.exampleTrans}</div>
      </div>
      
      <div class="bar">
        <button onclick="playWord('${w.word.replace(/'/g, "\\'")}')">ğŸ”Š å•è¯å‘éŸ³ (Azure)</button>
        <button onclick="playExample('${w.example.replace(/'/g, "\\'")}')">ğŸ§ ä¾‹å¥å‘éŸ³ (Azure)</button>
        <button class="alt" onclick="playDef('${w.englishDef.replace(/'/g, "\\'")}')">ğŸ“– é‡Šä¹‰å‘éŸ³ (Azure)</button>
        <button class="warn" onclick="stopAllAudio()" style="display:none">â¹ åœæ­¢</button>
      </div>
    </div>`;
  });
  
  box.innerHTML = html;
  updateAudioStatus();
}

function renderHistory(){
  const el = document.getElementById('history');
  const store = JSON.parse(localStorage.getItem('vocabHistory') || '{}');
  const days = Object.keys(store).sort().reverse();
  
  if (!days.length) {
    el.innerHTML = '<div class="muted">æš‚æ— å†å²è®°å½•ï¼Œä»Šæ—¥è®¿é—®åå°†è‡ªåŠ¨è®°å½•ã€‚</div>';
    return;
  }
  
  el.innerHTML = days.map(day => {
    const arr = store[day] || [];
    return `<details><summary>${day}ï¼ˆ${arr.length}è¯ï¼‰</summary><div style="margin-top:8px">${arr.map(x => `<span class='tag'>${x.word}</span>`).join('')}</div></details>`;
  }).join('');
}

function refreshToday(force) {
  renderToday(force);
  renderHistory();
}

// ==================== åˆå§‹åŒ– ====================
document.addEventListener('DOMContentLoaded', () => {
  refreshToday(false);
  
  // æ£€æŸ¥TTSä»£ç†æœåŠ¡
  fetch(TTS_PROXY_URL + '?text=test&voice=en-US-JennyNeural')
    .then(res => {
      if (!res.ok) {
        console.warn('Azure TTSä»£ç†æœåŠ¡å¯èƒ½æœªè¿è¡Œï¼Œå°†ä½¿ç”¨æµè§ˆå™¨è¯­éŸ³åˆæˆä½œä¸ºå¤‡é€‰');
      }
    })
    .catch(err => {
      console.warn('æ— æ³•è¿æ¥åˆ°Azure TTSä»£ç†æœåŠ¡:', err);
    });
});

// ==================== é”®ç›˜å¿«æ·é”® ====================
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    stopAllAudio();
  }
  if (e.key === ' ' && e.ctrlKey) {
    e.preventDefault();
    playAllWords();
  }
  if (e.key === 'e' && e.ctrlKey) {
    e.preventDefault();
    playAllExamples();
  }
  if (e.key === 'd' && e.ctrlKey) {
    e.preventDefault();
    playAllDefinitions();
  }
});
</script>
</body>
</html>