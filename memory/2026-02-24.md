# 2026-02-24 内存记录

## 静默自查 (05:00)
✅ 已完成每日静默自查：
1. **关键定时任务状态**：07:30/12:30/21:30新闻任务均启用并正常运行
   - `b62821aa-893f-4544-a59c-807a8cd43ea4` (daily-deep-us-stock-news-0730) - 状态ok，上次执行22小时前
   - `bde1842e-3f4c-4a1c-9a34-14498f341d25` (midday-us-stock-followup-1230) - 状态ok，上次执行17小时前
   - `253f5fdf-5b21-4b95-ba3b-1c86f4ed5b8d` (night-us-stock-risk-preview-2130) - 状态ok，上次执行5小时前
2. **最近24小时执行情况**：昨日所有关键任务正常执行，状态均为ok，无失败记录
3. **提示词检查**：AGENTS.md、SOUL.md、USER.md、TOOLS.md等关键文件完整，无意外覆盖
4. **自动修复**：本次未发现问题，无需修复

静默模式：无用户通知，仅内部记录。

## 酷狗TOP500采集流程优化 (12:44-13:20)

### 问题分析
基于2026-02-22的采集经验，原流程存在以下痛点：
1. **滚动漏项严重**：动态渲染导致自动滚动时约10%歌曲被跳过（468/500）
2. **人工干预多**：需要用户手动计算缺失排名并定位区段（如117-122、338等）
3. **状态管理弱**：缺乏进度跟踪，中断后需重新开始
4. **容错性差**：网络波动或UI变化容易导致失败
5. **反馈不清晰**：用户不清楚当前进度和缺失情况

### 优化方案
创建了完整的优化版采集系统，包含以下核心改进：

#### 1. 智能滚动算法
- 自适应滚动距离，基于屏幕尺寸精确控制
- 滚动后验证内容是否成功加载
- 较慢的滚动速度（300ms）有助于动态内容加载

#### 2. 状态管理系统
- 实时保存采集进度到JSON文件
- 支持断点续传（意外中断后可继续）
- 自动计算和跟踪缺失排名

#### 3. 容错机制
- ADB命令重试（最多3次）
- 元素查找失败的多重策略
- 异常状态自动恢复

#### 4. 人机协同优化
- 清晰的交互式菜单系统
- 智能建议缺失区段（自动分组显示）
- 一键定位到指定排名
- 实时进度反馈和状态显示

#### 5. 自动化报告生成
- 自动生成Markdown表格报告
- 生成Excel文件便于分析
- 生成详细统计报告
- 按日期自动归档

### 预期效果
- **成功率提升**：93% → 98%+
- **人工操作减少**：减少约70%
- **总时间节省**：减少30-40%
- **用户体验**：显著提升，操作更简便

### 创建的文件
1. `kugou_optimized_scraper.py` - 优化版采集主程序（包含返回按钮优化）
2. `采集流程优化指南.md` - 详细优化指南（包含返回按钮说明）
3. `test_optimization.py` - 优化效果测试脚本（3965字节）
4. `test_back_button.py` - 返回按钮功能测试工具（10682字节）
5. `kugou_full_auto.py` - 全自动采集系统（15550字节）
6. `全自动采集流程指南.md` - 全自动流程使用指南（5229字节）
7. `test_full_auto_quick.py` - 全自动流程快速测试（7463字节）

### 核心功能演示
```python
# 状态管理示例
状态文件：~/Documents/音乐/kugou_scrape_state.json
{
    "last_scraped_rank": 156,
    "scraped_ranks": [1,2,3,...,156],
    "missing_ranks": [157,158,...,500],
    "last_scroll_position": 1200,
    "start_time": "2026-02-24T12:44:00"
}

# 交互界面示例
酷狗TOP500采集系统 - 当前状态
============================================================
已采集: 468/500 首歌曲 (93.6%)
缺失: 32 首歌曲

缺失排名列表:
  117-122, 297-301, 338, 487-490

最后采集的排名: 466
开始时间: 2026-02-24T12:44:00
============================================================
```

### 使用建议
1. **首次运行**：先使用"自动滚动采集"获取大部分数据
2. **补位阶段**：查看系统建议的缺失区段进行补位
3. **疑难排名**：使用"指定排名采集"精确控制
4. **定期备份**：系统自动保存，但建议每50首后手动生成报告

### 关键优化点：返回按钮处理（用户反馈）
**问题**：原流程使用物理返回键（`keyevent 4`）在采集后返回，可能不可靠。

**解决方案**：
1. **精确返回**：添加 `find_and_click_back_button()` 方法，专门查找左上角"<"按钮
2. **多重策略**：
   - 文本匹配：查找"<"、"返回"、"Back"、"←"等标识
   - 区域定位：查找屏幕左上角1/8区域的可点击元素
   - 备用方案：物理返回键 + 再次尝试
3. **验证机制**：返回后验证页面是否包含"TOP500"标识
4. **测试工具**：创建 `test_back_button.py` 专门测试返回按钮功能

**预期效果**：
- 提高返回成功率，确保每次采集后正确返回到榜单页面
- 减少因返回失败导致的采集中断
- 提高整体采集流程的稳定性

### 经验总结
- 动态渲染榜单采集的关键是**智能滚动+状态管理**
- **人机协同**比全自动化更可靠（针对复杂UI）
- **实时反馈**对用户体验至关重要
- **容错机制**能显著提高成功率
- **精确的UI操作**：点击特定按钮比使用物理按键更可靠

### 全自动流程开发（用户需求）
**需求**：创建完全无需人工干预的全自动采集流程。

**解决方案**：
1. **创建全自动采集系统** `kugou_full_auto.py`：
   - 完整的日志系统（文件+控制台输出）
   - 智能滚动算法（自适应参数）
   - 多重容错机制（命令重试、状态恢复）
   - 断点续传功能（意外中断后可继续）
   - 自动化报告生成（多格式报告）

2. **核心优化**：
   - **状态管理**：实时保存采集进度，支持恢复
   - **性能统计**：记录采集时间、成功率等指标
   - **参数调优**：可调整的滚动距离、等待时间等
   - **验证机制**：每个步骤都有验证和重试

3. **预期效果**：
   - **完全自动化**：启动后无需任何人工干预
   - **高可靠性**：多重容错确保流程稳定
   - **完整报告**：自动生成详细采集报告
   - **易于监控**：实时日志和状态显示

### 使用建议
1. **首次测试**：先运行 `test_full_auto_quick.py` 验证环境
2. **小规模测试**：修改 `kugou_full_auto.py` 只采集前10首测试
3. **完整运行**：确认测试无误后运行完整500首采集
4. **监控进度**：使用 `tail -f` 查看实时日志

### 下一步
1. 运行 `test_full_auto_quick.py` 验证环境
2. 测试 `kugou_full_auto.py` 的前10首采集
3. 根据测试结果微调参数（滚动速度、等待时间等）
4. 运行完整的500首全自动采集

## 用户确认与长期要求 (15:06)
- 用户已确认收到两份文件（500榜单 xls + 对比 docx）。
- 用户要求将该能力作为长期流程保留，并表示后续“每日都会安排一次”。
- 明确邮箱策略：收发统一 `700008@qq.com`。

## 投资规则新增（用户指定）
- 标普500当月增持机制：
  1) 单日跌幅达到 -1%：执行当月定额增持。
  2) 若当月未触发(1)：第三个星期五收盘前执行当月定额增持。
  3) 在(1)或(2)已执行基础上，若当月跌幅达到 -5%：再加一笔定额增持。
  4) 触发并执行(3)后，当月不再增持。

## OpenWrt 运维与自动化（晚间新增）
- 用户家中路由设备可通过 SSH 登录（OpenWrt，主机 `192.168.2.2`），并要求后续协助运维。
- SSR Plus 已新增订阅并更新成功：`https://iplcsub.com/subscribe/36406/0kOSkhglOL/ssr/`。
- 已确认 OpenWrt 侧可访问 Google（DNS 与 HTTP/HTTPS 测试均通过）。
- 已配置/调整定时任务：
  - 每天 02:00 检测 Google；不可达则先重启路由。
  - 每天 02:10 进行节点切换与连通性恢复（切换后不重启服务，直接测 Google）。
  - SSR Plus 订阅更新改为每天 03:00。
  - 另保留每周一 04:00 重启与 04:08 检测任务。
- 用户偏好：相关说明与操作沟通使用中文。

## moomoo OpenAPI 接入进度
- 用户确认后续将接入 moomoo API，先从模拟盘（SIM）开始。
- 已在工作区创建接入骨架：
  - `moomoo_setup/.env.example`
  - `moomoo_setup/check_opend.py`
  - `moomoo_setup/README_CN.md`
- 已安装依赖 `futu-api`、`python-dotenv` 并运行连通测试；当前失败原因为 OpenD 未启动（127.0.0.1:11111 ECONNREFUSED）。
- 已代下载 Mac 版 OpenD 安装包：
  - `/Users/lin/.openclaw/workspace/moomoo_setup/downloads/moomoo_OpenD_9.6.5618_Mac.tar.gz`（约374MB）。