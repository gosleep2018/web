<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HotNewsï½œå››æ ç›®æ–°é—»çœ‹æ¿</title>
  <style>
    :root {
      --bg:#0b1220; --panel:#111827; --line:#1f2937; --muted:#9ca3af; --text:#e5e7eb;
      --blue:#1d4ed8; --blue2:#1e40af; --chip:#1e293b; --soft:#0f172a;
    }
    * { box-sizing:border-box; }
    body { margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",sans-serif; background:var(--bg); color:var(--text); }
    .wrap { max-width:1200px; margin:0 auto; padding:22px; }
    h1 { margin:0 0 8px; font-size:30px; }
    h2 { margin:18px 0 10px; font-size:20px; }
    .meta { color:var(--muted); margin-bottom:12px; }
    .toolbar { display:flex; gap:8px; margin:8px 0 14px; flex-wrap:wrap; }
    .btn { background:var(--blue); color:#fff; border:none; border-radius:10px; padding:8px 12px; font-size:13px; cursor:pointer; }
    .btn:hover { background:var(--blue2); }

    .grid4 { display:grid; grid-template-columns:repeat(2,minmax(280px,1fr)); gap:12px; }
    @media (max-width:900px){ .grid4{grid-template-columns:1fr;} }

    .card { background:var(--panel); border:1px solid var(--line); border-radius:14px; padding:14px; }
    .card h3 { margin:0 0 10px; font-size:18px; }
    .item { padding:10px; border:1px solid #1e293b; background:var(--soft); border-radius:10px; margin-bottom:8px; }
    .item:last-child { margin-bottom:0; }
    .zh a, .zh { color:#e2e8f0; text-decoration:none; }
    .zh a:hover { text-decoration:underline; }
    .en { color:#93c5fd; font-size:13px; margin-top:4px; line-height:1.35; }

    .tri { margin-top:16px; }
    .triCard { background:var(--panel); border:1px solid var(--line); border-radius:14px; padding:14px; margin-bottom:12px; }
    .event { font-weight:700; margin-bottom:8px; }
    .event .en { display:block; }
    .triGrid { display:grid; grid-template-columns:repeat(3,minmax(220px,1fr)); gap:10px; }
    @media (max-width:950px){ .triGrid{grid-template-columns:1fr;} }
    .col { border:1px solid #1e293b; border-radius:10px; background:var(--soft); padding:10px; }
    .col h4 { margin:0 0 6px; font-size:14px; color:#c7d2fe; }
    .empty { color:#64748b; font-size:13px; }
    .insight { margin-top:10px; background:#0b1a33; border:1px solid #1d3b70; border-radius:8px; padding:10px; font-size:14px; line-height:1.5; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>HotNewsï¼šå››æ ç›®æ–°é—»çœ‹æ¿</h1>
    <div class="meta" id="meta">åŠ è½½ä¸­... / Loading...</div>

    <div class="toolbar">
      <button id="readAllBtn" class="btn">ğŸ”Š æœ—è¯»ä¸‰è§’è§†è§’æ€»ç»“ / Read Triangle Summary</button>
    </div>

    <div class="grid4" id="fourCols"></div>

    <div class="tri">
      <h2>ä¸‰è§’è§†è§’ï¼ˆ2+åª’ä½“å…±åŒäº‹ä»¶ï¼‰</h2>
      <div id="triangle"></div>
    </div>
  </div>

  <script>
    const AZURE_TTS_BASE = 'https://web-x0ya.onrender.com';
    let __data = null;

    async function speakWithAzure(text){
      const q = encodeURIComponent(text);
      const voice = encodeURIComponent('en-US-JennyNeural');
      const url = `${AZURE_TTS_BASE}/tts?text=${q}&voice=${voice}`;
      const resp = await fetch(url, { method: 'GET' });
      if(!resp.ok) throw new Error('TTS request failed: ' + resp.status);
      const blob = await resp.blob();
      if (!blob || blob.size < 1024) throw new Error('Azure returned empty audio');
      const audioUrl = URL.createObjectURL(blob);
      const audio = new Audio(audioUrl);
      await audio.play();
    }

    function speakFallback(text){
      if (!('speechSynthesis' in window)) return;
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'en-US';
      window.speechSynthesis.speak(u);
    }

    function newsBlock(title, items){
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `<h3>${title}</h3>`;
      (items || []).slice(0,10).forEach(it => {
        const d = document.createElement('div');
        d.className = 'item';
        const zh = it.title_zh || it.title || '';
        const en = it.title_en || it.title || '';
        d.innerHTML = `<div class="zh"><a href="${it.link}" target="_blank" rel="noreferrer">${zh}</a></div>
                       <div class="en">${en}</div>
                       <div class="toolbar" style="margin-top:8px;">
                         <button class="btn" style="padding:6px 9px;font-size:12px;" onclick="window.readItem(${JSON.stringify(zh).replace(/"/g,'&quot;')}, ${JSON.stringify(en).replace(/"/g,'&quot;')})">ğŸ”Š è¯»ZH/EN</button>
                       </div>`;
        card.appendChild(d);
      });
      return card;
    }

    window.readItem = async (zh, en) => {
      const text = `Chinese: ${zh}. English: ${en}.`;
      try { await speakWithAzure(text); }
      catch(e){ speakFallback(text); }
    }

    function triCol(title, item){
      const col = document.createElement('div');
      col.className = 'col';
      col.innerHTML = `<h4>${title}</h4>`;
      if(item && item.link){
        const zh = item.title_zh || item.title || '';
        const en = item.title_en || item.title || '';
        col.innerHTML += `<div class="zh"><a href="${item.link}" target="_blank" rel="noreferrer">${zh}</a></div><div class="en">${en}</div>`;
      } else {
        col.innerHTML += `<div class="empty">æš‚æ—  / N/A</div>`;
      }
      return col;
    }

    async function load(){
      const res = await fetch('./data/news.json?_=' + Date.now());
      const data = await res.json();
      __data = data;
      document.getElementById('meta').textContent = `æœ€åæ›´æ–° / Last update: ${data.generated_at}ï¼ˆæ¯æ—¥ 08:00 è‡ªåŠ¨æ›´æ–°ï¼‰`;

      const four = document.getElementById('fourCols');
      four.innerHTML = '';
      four.appendChild(newsBlock('ä¸­å›½ / China', data.sources?.['ä¸­å›½'] || []));
      four.appendChild(newsBlock('ç¾å›½ï¼ˆæ¬§ç¾åª’ä½“ï¼‰ / US-Western Media', data.sources?.['ç¾å›½ï¼ˆæ¬§ç¾åª’ä½“ï¼‰'] || []));
      four.appendChild(newsBlock('ä¼Šæ–¯å…°ï¼ˆåŠå²›ç­‰ï¼‰ / Islamic (Al Jazeera etc.)', data.sources?.['ä¼Šæ–¯å…°ï¼ˆåŠå²›ç­‰ï¼‰'] || []));
      four.appendChild(newsBlock('ä¸‰è§’è§†è§’äº‹ä»¶åˆ—è¡¨ / Triangle Event List', (data.triangle || []).map(t => ({
        title_zh: t.event_hint_zh || t.event_hint,
        title_en: t.event_hint_en || t.event_hint,
        link: (t['ä¸­å›½']||t['ç¾å›½']||t['ä¼Šæ–¯å…°']||{}).link || '#'
      }))));

      const tri = document.getElementById('triangle');
      tri.innerHTML = '';
      (data.triangle || []).forEach((e, i) => {
        const c = document.createElement('div');
        c.className = 'triCard';
        c.innerHTML = `<div class="event">äº‹ä»¶ ${i+1}ï¼š${e.event_hint_zh || e.event_hint}<span class="en">${e.event_hint_en || e.event_hint}</span></div>`;
        const g = document.createElement('div');
        g.className = 'triGrid';
        g.appendChild(triCol('ä¸­å›½è§†è§’ / China', e['ä¸­å›½']));
        g.appendChild(triCol('ç¾å›½è§†è§’ / US-Western', e['ç¾å›½']));
        g.appendChild(triCol('ä¼Šæ–¯å…°è§†è§’ / Islamic', e['ä¼Šæ–¯å…°']));
        c.appendChild(g);
        const ins = document.createElement('div');
        ins.className = 'insight';
        ins.innerHTML = `<div><b>æˆ‘çš„çœ‹æ³• / My viewï¼š</b>${e.my_view || ''}</div><div style="margin-top:6px;"><b>æ€»ç»“ / Summaryï¼š</b>${e.summary || ''}</div>`;
        c.appendChild(ins);
        tri.appendChild(c);
      });
    }

    document.getElementById('readAllBtn').onclick = async () => {
      const events = (__data && __data.triangle) ? __data.triangle : [];
      if (!events.length) return;
      const text = events.map((e, i) => `Item ${i+1}. Event ${e.event_hint_en || ''}. My view: ${e.my_view || ''}. Summary: ${e.summary || ''}`).join(' ');
      try { await speakWithAzure(text); }
      catch(e){ speakFallback(text); }
    }

    load().catch(e => {
      document.getElementById('meta').textContent = 'åŠ è½½å¤±è´¥ / Load failed: ' + e.message;
    });
  </script>
</body>
</html>
