# OpenClaw 两天安装/配置复盘（供新系统复用）

更新时间：2026-02-19（Asia/Singapore）
适用对象：新系统重装后，快速恢复当前可用模型与稳定配置。

---

## 1) 本次最终可用状态（结论先看）

### 已可用模型
- 主模型：`anthropic/claude-sonnet-4-5`
- 备用1：`openai-codex/gpt-5.3-codex`
- 备用2：`deepseek/deepseek-chat`
- 备用3：`deepseek/deepseek-reasoner`

### 认证状态
- Claude：已完成 setup-token/OAuth token 配置（可用）
- GPT（openai-codex）：OAuth（可用）
- DeepSeek：API Key（可用）
- Gemini（google-gemini-cli）：**未完全稳定**（GCA OAuth 流程容易卡/失效）

### 容灾链路
已配置自动回退：
`Claude -> GPT -> DeepSeek Chat -> DeepSeek Reasoner`

---

## 2) 两天内关键经验（踩坑+解决）

## 2.1 Claude 为什么最初不可选
**现象**：切换 Claude 报不允许/不可用。
**根因**：`~/.openclaw/openclaw.json` 中缺少 `anthropic` provider。
**解决**：补齐 `models.providers.anthropic`，并完成 token 认证。

> 经验：模型“历史上可用”不代表当前配置还在，先查当前生效配置文件。

## 2.2 Gemini 400 invalid argument 的根因
**现象**：`Cloud Code Assist API error (400): Request contains an invalid argument.`
**根因**：GCA OAuth 未完成（缺 token），或使用了过期授权码。
**解决路径**：
1. 设置环境变量
2. `gemini auth login` 走浏览器授权
3. 授权码必须“新鲜且一次性”

> 经验：Gemini 的授权码和 `code_challenge` 强绑定，旧码复用必失败。

## 2.3 DeepSeek 配置注意点
- provider 使用 `openai-completions`
- `baseUrl` 用 `https://api.deepseek.com/v1`
- key 放在 `models.providers.deepseek.apiKey`

> 经验：DeepSeek 联通一般稳定，适合做第二/第三层容灾。

## 2.4 配置安全策略
- `openclaw.json` 最终权限建议：`400`（只读）
- 变更前先备份：`openclaw.json.backup-时间戳`
- 已新增一键恢复脚本（见第5节）

---

## 3) 新系统重装后推荐恢复顺序（最省事）

1. 安装 OpenClaw 与基础依赖（node、brew 组件）
2. 恢复 `~/.openclaw/openclaw.json`（优先用最近可用备份）
3. 恢复认证资料（尤其 Claude token / OpenAI Codex OAuth）
4. 验证模型主备链路
5. 最后再处理 Gemini（可延后）

---

## 4) 建议保留的核心配置片段（主备）

```json
{
  "agents": {
    "defaults": {
      "model": {
        "primary": "anthropic/claude-sonnet-4-5",
        "fallbacks": [
          "openai-codex/gpt-5.3-codex",
          "deepseek/deepseek-chat",
          "deepseek/deepseek-reasoner"
        ]
      },
      "models": {
        "anthropic/claude-sonnet-4-5": { "alias": "sonnet" },
        "openai-codex/gpt-5.3-codex": { "alias": "gpt" },
        "deepseek/deepseek-chat": { "alias": "deepseek" },
        "deepseek/deepseek-reasoner": { "alias": "deepseek-r1" }
      }
    }
  }
}
```

---

## 5) 已准备好的恢复文件

- 备份目录：`/Users/lin/.openclaw/workspace/backup`
- 一键恢复命令说明：`openclaw_recovery_command.txt`
- Windows 一键恢复脚本：`restore_last_good_backup.bat`
- 当前配置备份（示例）：`openclaw.json.backup-20260219-115411`

恢复网关常用命令：
```bash
openclaw gateway restart || openclaw gateway start
openclaw gateway status
```

---

## 6) 待办（下次有空做）

1. Gemini GCA OAuth 再完成一次（本机终端、同一浏览器会话）
2. 验证 `google-gemini-cli/gemini-3-pro-preview` 可用后，再加入 fallback 链
3. 排查 podcast TTS “连接失败”问题（网络或凭据）

---

## 7) 最短口令（给未来自己）

- 切主模型到 Claude：
  - 保持 `primary=anthropic/claude-sonnet-4-5`
- 出问题快速恢复：
  - `openclaw gateway restart || openclaw gateway start`
- 真崩了就回滚到上一个备份：
  - 运行 `backup/restore_last_good_backup.bat`（Windows）

---

备注：`memory_search` 当前不可用（环境缺对应 key），本文件基于现有日志、当前配置和这两天操作记录整理。